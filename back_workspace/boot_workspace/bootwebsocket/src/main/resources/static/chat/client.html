<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        /* 기본 스타일 초기화 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f4f6f8;
            color: #333;
            padding: 30px;
        }

        /* 전체 컨테이너 */
        #app {
            max-width: 800px;
            margin: 0 auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
        }

        /* 제목 */
        h2 {
            text-align: center;
            margin-bottom: 25px;
            color: #2c3e50;
        }

        /* 입력 필드와 버튼 */
        input[type="text"] {
            padding: 10px 15px;
            margin: 10px 5px 10px 0;
            border: 1px solid #ccc;
            border-radius: 6px;
            width: 250px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            border-color: #3498db;
            outline: none;
        }

        button {
            padding: 10px 16px;
            background-color: #3498db;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin: 5px 0;
        }

        button:hover {
            background-color: #2980b9;
        }

        /* 접속 정보 */
        p {
            margin: 15px 0;
            font-weight: bold;
            color: #2c3e50;
        }

        /* 리스트 스타일 */
        ul {
            list-style-type: none;
            padding-left: 0;
            margin-top: 10px;
            margin-bottom: 20px;
        }

        li {
            margin-bottom: 6px;
        }

        /* 메시지 로그 */
        h3 {
            margin-top: 20px;
            color: #34495e;
        }

        li::before {
            content: "💬 ";
        }

        /* 방 정보 스타일 */
        li > ul {
            margin-top: 5px;
            margin-left: 20px;
            background-color: #f0f3f5;
            padding: 10px;
            border-radius: 8px;
        }

        /* 방 이름 강조 */
        li b {
            color: #2c3e50;
        }

        /* 방 버튼 */
        li button {
            margin-right: 10px;
            margin-top: 5px;

        }

        /* 방 생성 입력 박스 */
        div input[placeholder="방이름 입력"] {
            width: 300px;
        }
    </style>

</head>
<body>
    <div id="app">
        <h2>Spring WebSocket 기반 채팅</h2>

        <!-- DB 연동을 하지 않고, 사용자를 직접 입력하여 채팅 진행-->
        <div v-if="!connected">
            <input type="text" placeholder="채팅 사용자명 입력" v-model="username">
            <button type="button" @click="connect()">접속하기</button>
        </div>
        <div v-else>
            <p><b>{{username}}</b>님 접속중</p>
            <button type="button" @click="disconnect()">접속종료</button>

            <div>
                <input type="text" placeholder="메시지를 입력하세요" v-model="message" @keyup.enter="sendMessage">
                <button type="button" @click="sendMessage()">메시지 전송</button>
            </div>
        </div>

        <h3>총 접속자</h3>
        <ul>
            <li v-for="user in users">{{user}}</li>
        </ul>

        <h3>메시지 로그</h3>
        <ul>
            <li v-for="msg in messages">{{msg.sender}}님의 말: {{msg.content}}</li>
        </ul>

        <div>
            <input type="text" placeholder="방이름 입력" v-model="roomName">
            <button type="button" @click="createRoom()">방 만들기</button>
        </div>

        <h3>방 목록</h3>
        <ul>
            <li v-for="room in rooms" :key="room.roomId">
                <b>{{room.roomName}}</b> (참여자 수: {{room.users.length}})
                <ul>
                    <li v-for="user in room.users">{{user}}</li>
                    <button type="button" @click="enterRoom(room.roomId)">참여하기</button>
                    <button type="button" @click="leaveRoom(room.roomId)">나가기</button>
                </ul>
            </li>
        </ul>
    </div>

    <script>
        const {createApp, ref} = Vue;

        createApp({
            setup(){
                const connected = ref(false); //접속여부 판단
                const username = ref("");     //사용자명 변수
                let socket = null;
                const message = ref("");
                const users=ref([]);        //전체 접속자 목록
                const messages=ref([]); //채팅 메시지 목록

                const roomName=ref("");     //새로 만들방 이름
                const rooms=ref([]);

                /*------------------------------------------------------------
                * 공통 메시지 보내기
                * ----------------------------------------------------------*/
                const send=(payload)=>{
                    socket.send(JSON.stringify(payload));
                }

                /*------------------------------------------------------------
                 * 서버와 연결
                 * ----------------------------------------------------------*/
                const connect=()=>{
                    //username 자체를 바꾸는게 아니라 그 value를 바꾸는 것이므로 const로 선언한
                    //바인드 변수도 사용 가능하다.
                    if(!username.value.trim()){
                        alert("이름을 입력하세요");
                        return;
                    }

                    //서버와 WebSocket 연결 시도
                    socket = new WebSocket("ws://localhost:9999/ws");

                    //onopen이 호출되었다는 것은 서버와의 연결이 성공했다는 의미
                    socket.onopen=()=>{
                        //성공을 보장한 코드이므로 바인딩 변수 connected=true로 놓자, 디자인 자동 반영
                        connected.value = true;

                        //서버에 접속여부 알리기
                        send({
                            type:"CONNECT",
                            sender: username.value
                        });

                        send({type:"ROOM_LIST"});
                    }

                    //서버로부터 메시지를 받을 때 실행되는 콜백
                    socket.onmessage=(e)=>{
                        console.log("서버가 보낸 메시지", e.data);
                        let json = JSON.parse(e.data);

                        if(json.destination == "/users"){   //서버가 보낸 정보가 유저 목록임을 알 수 있다.
                            users.value = json.body;
                        }else if(json.destination == "/messages"){
                            messages.value.push(json.body);
                        }else if(json.destination == "/rooms"){
                            console.log(json);
                            rooms.value = json.body;
                        }
                    }
                }

                /*------------------------------------------------------------
                 * 메시지 보내기
                 * ----------------------------------------------------------*/
                const sendMessage=()=>{
                    //메시지가 비어있지 않을 경우만, 서버에 전송
                    if(message.value.trim()){
                       send({
                           type:"MESSAGE",
                           sender: username.value,
                           content: message.value
                       });
                       message.value="";    //입력값 초기화
                    }
                }

                /*------------------------------------------------------------
                * 방 만들기
                * ----------------------------------------------------------*/
                const createRoom=()=>{
                    if(roomName.value.trim()){
                        send({
                            type:"ROOM_CREATE",
                            sender: username.value,
                            content: roomName.value
                        });
                        roomName.value="";
                    }
                }

                /*------------------------------------------------------------
               * 방 참여
               * ----------------------------------------------------------*/
                const enterRoom = (roomId)=>{
                    send({
                        type: "ROOM_ENTER",
                        sender: username.value,
                        roomId: roomId
                    });
                }

                /*------------------------------------------------------------
               * 방 나가기
               * ----------------------------------------------------------*/
                const leaveRoom = (roomId)=>{
                    send({
                        type: "ROOM_LEAVE",
                        sender: username.value,
                        roomId: roomId
                    });
                }

                /*------------------------------------------------------------
                * 접속해제
                * ----------------------------------------------------------*/
                const disconnect=()=>{
                    //서버에 접속 끊을지 알리기
                    send({
                        type:"DISCONNECT",
                        sender: username.value
                    });
                    socket.close();

                    //소켓이 닫힌 상태에서는 서버의 브로드캐스트를 받을 수 없기 대문에
                    //현재 접속자 목록에서 나를 수동으로 제거해야 한다..
                    let newUsers = [];
                    //기존 유저 목록이 들어있는 배열에서, 현재 사용자를 제거한 후 최종 배열을 생성
                    for(let i=0; i<users.length; i++){
                        if(users.value[i] != username.value){
                            newUsers.push(users.value[i]);
                        }
                    }
                    users.value=newUsers;
                }

                return {connected, username, message, users, messages, roomName, rooms,
                    connect, sendMessage, createRoom, enterRoom, leaveRoom, disconnect}
            }
        }).mount("#app");
    </script>
</body>
</html>