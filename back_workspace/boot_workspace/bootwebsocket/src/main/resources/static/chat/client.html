<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™” */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f4f6f8;
            color: #333;
            padding: 30px;
        }

        /* ì „ì²´ ì»¨í…Œì´ë„ˆ */
        #app {
            max-width: 800px;
            margin: 0 auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
        }

        /* ì œëª© */
        h2 {
            text-align: center;
            margin-bottom: 25px;
            color: #2c3e50;
        }

        /* ì…ë ¥ í•„ë“œì™€ ë²„íŠ¼ */
        input[type="text"] {
            padding: 10px 15px;
            margin: 10px 5px 10px 0;
            border: 1px solid #ccc;
            border-radius: 6px;
            width: 250px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            border-color: #3498db;
            outline: none;
        }

        button {
            padding: 10px 16px;
            background-color: #3498db;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin: 5px 0;
        }

        button:hover {
            background-color: #2980b9;
        }

        /* ì ‘ì† ì •ë³´ */
        p {
            margin: 15px 0;
            font-weight: bold;
            color: #2c3e50;
        }

        /* ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        ul {
            list-style-type: none;
            padding-left: 0;
            margin-top: 10px;
            margin-bottom: 20px;
        }

        li {
            margin-bottom: 6px;
        }

        /* ë©”ì‹œì§€ ë¡œê·¸ */
        h3 {
            margin-top: 20px;
            color: #34495e;
        }

        li::before {
            content: "ğŸ’¬ ";
        }

        /* ë°© ì •ë³´ ìŠ¤íƒ€ì¼ */
        li > ul {
            margin-top: 5px;
            margin-left: 20px;
            background-color: #f0f3f5;
            padding: 10px;
            border-radius: 8px;
        }

        /* ë°© ì´ë¦„ ê°•ì¡° */
        li b {
            color: #2c3e50;
        }

        /* ë°© ë²„íŠ¼ */
        li button {
            margin-right: 10px;
            margin-top: 5px;

        }

        /* ë°© ìƒì„± ì…ë ¥ ë°•ìŠ¤ */
        div input[placeholder="ë°©ì´ë¦„ ì…ë ¥"] {
            width: 300px;
        }
    </style>

</head>
<body>
    <div id="app">
        <h2>Spring WebSocket ê¸°ë°˜ ì±„íŒ…</h2>

        <!-- DB ì—°ë™ì„ í•˜ì§€ ì•Šê³ , ì‚¬ìš©ìë¥¼ ì§ì ‘ ì…ë ¥í•˜ì—¬ ì±„íŒ… ì§„í–‰-->
        <div v-if="!connected">
            <input type="text" placeholder="ì±„íŒ… ì‚¬ìš©ìëª… ì…ë ¥" v-model="username">
            <button type="button" @click="connect()">ì ‘ì†í•˜ê¸°</button>
        </div>
        <div v-else>
            <p><b>{{username}}</b>ë‹˜ ì ‘ì†ì¤‘</p>
            <button type="button" @click="disconnect()">ì ‘ì†ì¢…ë£Œ</button>

            <div>
                <input type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" v-model="message" @keyup.enter="sendMessage">
                <button type="button" @click="sendMessage()">ë©”ì‹œì§€ ì „ì†¡</button>
            </div>
        </div>

        <h3>ì´ ì ‘ì†ì</h3>
        <ul>
            <li v-for="user in users">{{user}}</li>
        </ul>

        <h3>ë©”ì‹œì§€ ë¡œê·¸</h3>
        <ul>
            <li v-for="msg in messages">{{msg.sender}}ë‹˜ì˜ ë§: {{msg.content}}</li>
        </ul>

        <div>
            <input type="text" placeholder="ë°©ì´ë¦„ ì…ë ¥" v-model="roomName">
            <button type="button" @click="createRoom()">ë°© ë§Œë“¤ê¸°</button>
        </div>

        <h3>ë°© ëª©ë¡</h3>
        <ul>
            <li v-for="room in rooms" :key="room.roomId">
                <b>{{room.roomName}}</b> (ì°¸ì—¬ì ìˆ˜: {{room.users.length}})
                <ul>
                    <li v-for="user in room.users">{{user}}</li>
                    <button type="button" @click="enterRoom(room.roomId)">ì°¸ì—¬í•˜ê¸°</button>
                    <button type="button" @click="leaveRoom(room.roomId)">ë‚˜ê°€ê¸°</button>
                </ul>
            </li>
        </ul>
    </div>

    <script>
        const {createApp, ref} = Vue;

        createApp({
            setup(){
                const connected = ref(false); //ì ‘ì†ì—¬ë¶€ íŒë‹¨
                const username = ref("");     //ì‚¬ìš©ìëª… ë³€ìˆ˜
                let socket = null;
                const message = ref("");
                const users=ref([]);        //ì „ì²´ ì ‘ì†ì ëª©ë¡
                const messages=ref([]); //ì±„íŒ… ë©”ì‹œì§€ ëª©ë¡

                const roomName=ref("");     //ìƒˆë¡œ ë§Œë“¤ë°© ì´ë¦„
                const rooms=ref([]);

                /*------------------------------------------------------------
                * ê³µí†µ ë©”ì‹œì§€ ë³´ë‚´ê¸°
                * ----------------------------------------------------------*/
                const send=(payload)=>{
                    socket.send(JSON.stringify(payload));
                }

                /*------------------------------------------------------------
                 * ì„œë²„ì™€ ì—°ê²°
                 * ----------------------------------------------------------*/
                const connect=()=>{
                    //username ìì²´ë¥¼ ë°”ê¾¸ëŠ”ê²Œ ì•„ë‹ˆë¼ ê·¸ valueë¥¼ ë°”ê¾¸ëŠ” ê²ƒì´ë¯€ë¡œ constë¡œ ì„ ì–¸í•œ
                    //ë°”ì¸ë“œ ë³€ìˆ˜ë„ ì‚¬ìš© ê°€ëŠ¥í•˜ë‹¤.
                    if(!username.value.trim()){
                        alert("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”");
                        return;
                    }

                    //ì„œë²„ì™€ WebSocket ì—°ê²° ì‹œë„
                    socket = new WebSocket("ws://localhost:9999/ws");

                    //onopenì´ í˜¸ì¶œë˜ì—ˆë‹¤ëŠ” ê²ƒì€ ì„œë²„ì™€ì˜ ì—°ê²°ì´ ì„±ê³µí–ˆë‹¤ëŠ” ì˜ë¯¸
                    socket.onopen=()=>{
                        //ì„±ê³µì„ ë³´ì¥í•œ ì½”ë“œì´ë¯€ë¡œ ë°”ì¸ë”© ë³€ìˆ˜ connected=trueë¡œ ë†“ì, ë””ìì¸ ìë™ ë°˜ì˜
                        connected.value = true;

                        //ì„œë²„ì— ì ‘ì†ì—¬ë¶€ ì•Œë¦¬ê¸°
                        send({
                            type:"CONNECT",
                            sender: username.value
                        });

                        send({type:"ROOM_LIST"});
                    }

                    //ì„œë²„ë¡œë¶€í„° ë©”ì‹œì§€ë¥¼ ë°›ì„ ë•Œ ì‹¤í–‰ë˜ëŠ” ì½œë°±
                    socket.onmessage=(e)=>{
                        console.log("ì„œë²„ê°€ ë³´ë‚¸ ë©”ì‹œì§€", e.data);
                        let json = JSON.parse(e.data);

                        if(json.destination == "/users"){   //ì„œë²„ê°€ ë³´ë‚¸ ì •ë³´ê°€ ìœ ì € ëª©ë¡ì„ì„ ì•Œ ìˆ˜ ìˆë‹¤.
                            users.value = json.body;
                        }else if(json.destination == "/messages"){
                            messages.value.push(json.body);
                        }else if(json.destination == "/rooms"){
                            console.log(json);
                            rooms.value = json.body;
                        }
                    }
                }

                /*------------------------------------------------------------
                 * ë©”ì‹œì§€ ë³´ë‚´ê¸°
                 * ----------------------------------------------------------*/
                const sendMessage=()=>{
                    //ë©”ì‹œì§€ê°€ ë¹„ì–´ìˆì§€ ì•Šì„ ê²½ìš°ë§Œ, ì„œë²„ì— ì „ì†¡
                    if(message.value.trim()){
                       send({
                           type:"MESSAGE",
                           sender: username.value,
                           content: message.value
                       });
                       message.value="";    //ì…ë ¥ê°’ ì´ˆê¸°í™”
                    }
                }

                /*------------------------------------------------------------
                * ë°© ë§Œë“¤ê¸°
                * ----------------------------------------------------------*/
                const createRoom=()=>{
                    if(roomName.value.trim()){
                        send({
                            type:"ROOM_CREATE",
                            sender: username.value,
                            content: roomName.value
                        });
                        roomName.value="";
                    }
                }

                /*------------------------------------------------------------
               * ë°© ì°¸ì—¬
               * ----------------------------------------------------------*/
                const enterRoom = (roomId)=>{
                    send({
                        type: "ROOM_ENTER",
                        sender: username.value,
                        roomId: roomId
                    });
                }

                /*------------------------------------------------------------
               * ë°© ë‚˜ê°€ê¸°
               * ----------------------------------------------------------*/
                const leaveRoom = (roomId)=>{
                    send({
                        type: "ROOM_LEAVE",
                        sender: username.value,
                        roomId: roomId
                    });
                }

                /*------------------------------------------------------------
                * ì ‘ì†í•´ì œ
                * ----------------------------------------------------------*/
                const disconnect=()=>{
                    //ì„œë²„ì— ì ‘ì† ëŠì„ì§€ ì•Œë¦¬ê¸°
                    send({
                        type:"DISCONNECT",
                        sender: username.value
                    });
                    socket.close();

                    //ì†Œì¼“ì´ ë‹«íŒ ìƒíƒœì—ì„œëŠ” ì„œë²„ì˜ ë¸Œë¡œë“œìºìŠ¤íŠ¸ë¥¼ ë°›ì„ ìˆ˜ ì—†ê¸° ëŒ€ë¬¸ì—
                    //í˜„ì¬ ì ‘ì†ì ëª©ë¡ì—ì„œ ë‚˜ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ì œê±°í•´ì•¼ í•œë‹¤..
                    let newUsers = [];
                    //ê¸°ì¡´ ìœ ì € ëª©ë¡ì´ ë“¤ì–´ìˆëŠ” ë°°ì—´ì—ì„œ, í˜„ì¬ ì‚¬ìš©ìë¥¼ ì œê±°í•œ í›„ ìµœì¢… ë°°ì—´ì„ ìƒì„±
                    for(let i=0; i<users.length; i++){
                        if(users.value[i] != username.value){
                            newUsers.push(users.value[i]);
                        }
                    }
                    users.value=newUsers;
                }

                return {connected, username, message, users, messages, roomName, rooms,
                    connect, sendMessage, createRoom, enterRoom, leaveRoom, disconnect}
            }
        }).mount("#app");
    </script>
</body>
</html>