<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™” */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f4f6f8;
            color: #333;
            padding: 30px;
        }

        /* ì „ì²´ ì»¨í…Œì´ë„ˆ */
        #app {
            max-width: 800px;
            margin: 0 auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
        }

        /* ì œëª© */
        h2 {
            text-align: center;
            margin-bottom: 25px;
            color: #2c3e50;
        }

        /* ì…ë ¥ í•„ë“œì™€ ë²„íŠ¼ */
        input[type="text"] {
            padding: 10px 15px;
            margin: 10px 5px 10px 0;
            border: 1px solid #ccc;
            border-radius: 6px;
            width: 250px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            border-color: #3498db;
            outline: none;
        }

        button {
            padding: 10px 16px;
            background-color: #3498db;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin: 5px 0;
        }

        button:hover {
            background-color: #2980b9;
        }

        /* ì ‘ì† ì •ë³´ */
        p {
            margin: 15px 0;
            font-weight: bold;
            color: #2c3e50;
        }

        /* ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        ul {
            list-style-type: none;
            padding-left: 0;
            margin-top: 10px;
            margin-bottom: 20px;
        }

        li {
            margin-bottom: 6px;
        }

        /* ë©”ì‹œì§€ ë¡œê·¸ */
        h3 {
            margin-top: 20px;
            color: #34495e;
        }

        li::before {
            content: "ğŸ’¬ ";
        }

        /* ë°© ì •ë³´ ìŠ¤íƒ€ì¼ */
        li > ul {
            margin-top: 5px;
            margin-left: 20px;
            background-color: #f0f3f5;
            padding: 10px;
            border-radius: 8px;
        }

        /* ë°© ì´ë¦„ ê°•ì¡° */
        li b {
            color: #2c3e50;
        }

        /* ë°© ë²„íŠ¼ */
        li button {
            margin-right: 10px;
            margin-top: 5px;
        }

        /* ë°© ìƒì„± ì…ë ¥ ë°•ìŠ¤ */
        div input[placeholder="ë°©ì´ë¦„ ì…ë ¥"] {
            width: 300px;
        }
    </style>

</head>
<body>
<div id="app">
    <h2>Spring WebSocket ê¸°ë°˜ ì±„íŒ… </h2>

    <!--DB ì—°ë™í•˜ì§€ ì•Šê³ , ì‚¬ìš©ìë¥¼ ì§ì ‘ ì…ë ¥í•˜ì—¬ ì±„íŒ…ì§„í–‰ -->
    <div v-if="!connected">
        <input type="text" v-model="username" placeholder="ì±„íŒ… ì‚¬ìš©ìëª… ì…ë ¥">
        <button type="button" @click="connect()">ì›¹ì†Œì¼“ì„œë²„ ì ‘ì†</button>
    </div>
    <div v-else>
        <p><b>{{username}}</b>ë‹˜ ì ‘ì†ì¤‘</p>
        <button type="button" @click="disconnect()">ì ‘ì†ì¢…ë£Œ</button>

        <div>
            <input type="text" v-model="message" @keyup.enter="sendMessage()" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            <button type="button" @click="sendMessage()">ë©”ì‹œì§€ ì „ì†¡</button>
        </div>
    </div>

    <h3>ì´ ì ‘ì†ì</h3>
    <ul>
        <li v-for="user in users">{{user}}</li>
    </ul>

    <h3>ë©”ì‹œì§€ ë¡œê·¸</h3>
    <ul>
        <li v-for="msg in messages">{{msg.sender}}ë‹˜ì˜ ë§: {{msg.content}}</li>
    </ul>

    <div>
        <input type="text" v-model="roomName" placeholder="ë°©ì´ë¦„ ì…ë ¥">
        <button type="button" @click="createRoom()">ë°©ë§Œë“¤ê¸°</button>
    </div>

    <h3>ë°©ëª©ë¡</h3>
    <ul>
        <li v-for="room in rooms" :key="room.roomId">
            <b>{{room.roomName}}</b> (ì°¸ì—¬ì ìˆ˜: {{room.users.length}})
            <ul>
                <li v-for="user in room.users">{{user}}</li>
                <button type="button" @click="enterRoom(room.roomId)">ì°¸ì—¬í•˜ê¸°</button>
                <button type="button" @click="leaveRoom(room.roomId)">ë‚˜ê°€ê¸°</button>
            </ul>
        </li>
    </ul>
</div>
<script>
    const {createApp, ref} = Vue;

    createApp({
        setup(){
            const username=ref("");
            const connected=ref(false);
            const users=ref([]);
            const message=ref("");
            const messages=ref([]);
            const roomName=ref("");     //ë°© ì œëª©
            const rooms=ref([]);


            let stompClient=null; //STOMP í´ë¼ì´ì–¸íŠ¸ ê°ì²´

            //ì›¹ì†Œì¼“ ì„œë²„ì— ì ‘ì† ì‹œë„
            const connect =()=>{
                //ì±„íŒ… ì•„ì´ë””ë¥¼ ì…ë ¥í–ˆì„ë•Œë§Œ ì ‘ì† ì‹œë„
                if(!username.value.trim() ){
                    alert("ì±„íŒ… ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
                    return; //ë©”ì„œë“œ ì¢…ë£Œ
                }
                //ìš°ë¦¬ì˜ ê²½ìš° ì›¹ì†Œì¼“ ìœ„ì— STOMPë¥¼ ì–¹í˜€ ì‚¬ìš©í•  ì˜ˆì •ì´ë¯€ë¡œ,
                //ë°˜ë“œì‹œ WebSocket ê°ì²´ê°€ í•„ìš”í•¨
                const socket=new WebSocket("ws://localhost:7777/ws");
                stompClient = Stomp.over(socket);//WebSocket ìœ„ì— STOMP í”„ë¡œí† ì½œ ì˜¬ë¦¬ê¸°

                //ì„œë²„ì™€ STOMP ì—°ê²° ì‹œë„(í—¤ë” ì •ë³´ ì—†ì´)
                stompClient.connect({}, ()=>{
                    connected.value=true;//ë°”ì¸ë”© ë³€ìˆ˜ë¥¼ trueë¡œ ë†“ì•„ì•¼ í™”ë©´ì „í™˜

                    //ì ‘ì†ê³¼ ë™ì‹œì— ì›í•˜ëŠ” ì±„ë„ì„ êµ¬ë…í•˜ì
                    stompClient.subscribe("/topic/users", (msg)=>{
                        console.log("ì ‘ì†ê³¼ ë™ì‹œì— êµ¬ë… ë©”ì‹œì§€ ë°›ê¸°",msg);
                        users.value=JSON.parse(msg.body);
                    });

                    //ì±„íŒ… ë©”ì‹œì§€ êµ¬ë…
                    stompClient.subscribe("/topic/messages", (msg)=>{
                        messages.value.push(JSON.parse(msg.body));
                    });

                    //ì„œë²„ì— ë©”ì‹œì§€ ë³´ë‚´ê¸°
                    stompClient.send("/app/connect", {}, JSON.stringify({sender:username.value}));

                    //ë°© ëª©ë¡ì„ ë°›ê¸° ìœ„í•œ ì±„ë„ êµ¬ë…
                    stompClient.subscribe("/topic/rooms", (msg)=>{
                        rooms.value = JSON.parse(msg.body);
                    });

                    //ì ‘ì†ê³¼ ë™ì‹œì— ë°© ëª©ë¡ì„ ìš”ì²­í•œë‹¤.
                    getRooms();
                });
            }

            //ë©”ì‹œì§€ ì „ì†¡
            const sendMessage=()=>{
                //ë©”ì‹œì§€ ì…ë ¥ë°•ìŠ¤ê°€ ë¹„ì–´ìˆì§€ ì•Šë‹¤ë©´
                if(message.value.trim()){
                    stompClient.send("/app/chat.send", {}, JSON.stringify({
                        sender:username.value,
                        content:message.value
                    }));
                }
            }

            //ë°© ë§Œë“¤ê¸°
            const createRoom=()=>{
                //ë°©ì œëª©ì„ ì…ë ¥í•œ ê²½ìš°ë§Œ
                if(roomName.value.trim()){
                    stompClient.send("/app/room.create", {}, JSON.stringify({
                        sender: username.value,
                        content: roomName.value
                    }));
                    roomName.value = "";    //ì…ë ¥ê°’ ì´ˆê¸°í™”
                }
            }

            //ë°© ëª©ë¡ êµ¬í•˜ê¸°
            const getRooms=()=>{
                stompClient.send("/app/room.list", {}, {});
            }

            //ë°© ì°¸ì—¬í•˜ê¸°
            const enterRoom=(roomId)=>{
                stompClient.send("/app/room.enter", {}, JSON.stringify({
                    sender: username.value,
                    roomId: roomId
                }));
            }

            //ë°© ë‚˜ê°€ê¸°
            const leaveRoom=(roomId)=>{
                stompClient.send("/app/room.leave", {}, JSON.stringify({
                    sender: username.value,
                    roomId: roomId
                }))
            }

            //ì ‘ì†ì¢…ë£Œ
            const disconnect=()=>{
                //ì¢…ë£Œë¡œ ì¸í•˜ì—¬ ì›¹ì†Œì¼“ì´ ëŠê¸°ë©´ ì„œë²„ê°€ ë³´ë‚´ì¤€ êµ¬ë… ë¸Œë¡œë“œìºìŠ¤íŒ… ì •ë³´ ì¡°ì°¨ ë°›ì„ ìˆ˜ ì—†ë‹¤.

                //ì„œë²„ì— 'ë‚˜ ë‚˜ê°ˆë˜' ì•Œë¦¼ ë³´ë‚´ê¸°
                stompClient.send("/app/disconnect", {}, JSON.stringify({
                    sender: username.value,
                }));

                //ì´ë¯¸ ì ‘ì†ì´ ëŠì–´ì§„ ì´í›„ì—” ë¸Œë¡œë“œìºìŠ¤íŒ…ì„ ë°›ì§€ ëª»í•˜ë¯€ë¡œ, ë‚˜ì˜ ì •ë³´ë¥¼ ìŠ¤ìŠ¤ë¡œ ì œê±°
                //ì°¸ì—¬ì ëª©ë¡ì„ ë‹¤ì‹œ êµ¬ì„±
                let newUsers = [];
                for(let i=0; i<users.value.length; i++){
                    if(users.value[i] != username.value){
                        newUsers.push(users[i].value);
                    }
                }
                users.value = newUsers;

                stompClient.disconnect();   //ëª¨ë“  ì‚¬ìš©ìì—ê²Œ ë‚˜ê°”ìŒì„ ì•Œë ¸ìœ¼ë¯€ë¡œ, ë‚˜ ì£½ê¸°
                connected.value = false;    //ë·° í™”ë©´ ê°±ì‹ ì„ ìœ„í•´
            }


            return {username, connected, users, message, messages, roomName, rooms,
                connect, sendMessage, createRoom, getRooms, enterRoom, leaveRoom, disconnect}
        }
    }).mount("#app");
</script>
</body>
</html>